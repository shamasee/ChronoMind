<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ChronoMind AI 6.0 (Enhanced Intelligence)</title>
    <!--
      ChronoMind AI: Single-File Premium Stopwatch & Timer Application
      Version: 6.0.1 (Corrected & Verified)
      Author: Gemini
      Description: A fully functional, production-ready, offline-first mobile application
                   with an embedded AI, all contained within a single HTML file. This version
                   introduces robust JSON data export and import, records precise session start/finish times,
                   and features a significantly upgraded AI with long-term memory for deep personalization,
                   habit learning, and proactive assistance. The AI can now learn user names, common activities,
                   and provide tailored goals and insights. This version includes the corrected code for all features.
    -->
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Teko:wght@300;400;600&display=swap" rel="stylesheet">

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ------------------- */
        /* --- CSS Reset & Globals --- */
        /* ------------------- */
        :root {
            --bg-color: #f4f7f9;
            --text-color: #1a1c2c;
            --primary-color: #007aff;
            --primary-gradient: linear-gradient(45deg, #007aff, #5856d6);
            --secondary-color: #34c759;
            --accent-color: #ff9500;
            --danger-color: #ff3b30;
            --pin-color: #5856d6;
            --card-bg: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --border-color: #e8e8e8;
            --header-bg: rgba(255, 255, 255, 0.8);
            --font-family-display: 'Orbitron', sans-serif;
            --font-family-body: 'Teko', sans-serif;
            --transition-speed: 0.4s;
        }

        html.dark {
            --bg-color: #000000;
            --text-color: #f0f0f5;
            --primary-color: #0a84ff;
            --primary-gradient: linear-gradient(45deg, #0a84ff, #5e5ce6);
            --secondary-color: #30d158;
            --accent-color: #ff9f0a;
            --danger-color: #ff453a;
            --pin-color: #5e5ce6;
            --card-bg: #1c1c1e;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --border-color: #3a3a3c;
            --header-bg: rgba(28, 28, 30, 0.8);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden; /* Prevent body scrolling */
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family-body);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            font-size: clamp(18px, 2.5vw, 22px); /* Responsive font size */
            letter-spacing: 0.5px;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            position: relative;
        }
        
        /* ------------------- */
        /* --- Layout & Structure (IMPROVED) --- */
        /* ------------------- */
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh; /* Full viewport height */
            height: -webkit-fill-available; /* iOS full height fix */
        }
        
        .app-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: var(--header-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 15px clamp(15px, 5vw, 30px); /* Responsive padding */
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color var(--transition-speed) ease, border-color var(--transition-speed) ease;
            flex-shrink: 0; /* Prevent header from shrinking */
        }

        .app-header h1 {
            font-family: var(--font-family-display);
            font-size: clamp(24px, 6vw, 32px); /* Responsive header font size */
            font-weight: 700;
        }

        .theme-toggle {
            cursor: pointer;
            font-size: clamp(22px, 5vw, 28px);
            background: none;
            border: none;
            color: var(--text-color);
        }
        
        main {
            flex-grow: 1; /* Allow main to take up remaining space */
            overflow-y: auto; /* Enable scrolling within main content */
            padding: clamp(15px, 4vw, 30px) clamp(15px, 4vw, 30px);
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            height: 100%; /* Needed for children with 100% height */
        }
        
        .view {
            display: none;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .view.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
            height: 100%; /* Allow views to fill the main container */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .app-nav {
            position: relative; /* Changed from fixed */
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--header-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            padding-bottom: calc(10px + env(safe-area-inset-bottom)); /* iOS safe area */
            z-index: 1000;
            flex-shrink: 0; /* Prevent nav from shrinking */
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--text-color);
            opacity: 0.6;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: clamp(14px, 2.2vw, 18px);
            font-weight: 500;
            transition: opacity var(--transition-speed) ease, color var(--transition-speed) ease, transform 0.2s ease;
        }
        
        .nav-btn .icon {
            font-size: clamp(22px, 5vw, 28px);
            margin-bottom: 4px;
        }
        
        .nav-btn.active {
            color: var(--primary-color);
            opacity: 1;
            transform: scale(1.1);
        }
        
        /* ------------------- */
        /* --- Timer View (NEW ANIMATED UI) --- */
        /* ------------------- */
        .timer-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: clamp(15px, 4vh, 30px);
            padding-top: 5vh; /* Replaced margin-top with padding */
        }
        
        .mode-switcher {
            display: flex;
            background-color: var(--card-bg);
            border-radius: 20px;
            padding: 5px;
            box-shadow: 0 4px 15px var(--shadow-color);
            border: 1px solid var(--border-color);
        }

        .mode-btn {
            padding: 8px 20px;
            font-size: clamp(16px, 2.5vw, 20px);
            font-family: var(--font-family-body);
            font-weight: 600;
            border: none;
            background-color: transparent;
            color: var(--text-color);
            border-radius: 15px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .mode-btn.active {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 20px rgba(0, 122, 255, 0.4);
        }
        
        .timer-display-wrapper {
            position: relative;
            margin: 20px 0;
        }

        .timer-display-wrapper::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120%;
            height: 120%;
            background: radial-gradient(circle, var(--primary-color) 0%, rgba(255,255,255,0) 70%);
            opacity: 0.1;
            filter: blur(30px);
            z-index: -1;
            transition: opacity var(--transition-speed) ease;
        }
        html.dark .timer-display-wrapper::before {
             opacity: 0.15;
        }

        .timer-display {
            font-family: var(--font-family-body);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            line-height: 1;
        }
        .digit-group {
            display: flex;
        }
        .digit-container {
            font-size: clamp(3rem, 20vw, 7rem);
            font-weight: 400;
            width: 0.6em; /* Fixed width based on font size */
            height: 1em; /* Fixed height based on font size */
            overflow: hidden;
            position: relative;
        }
        .digit-roller {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 1000%; /* 10 digits (0-9) */
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .digit {
            height: 10%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .separator {
            font-size: clamp(2rem, 15vw, 5rem);
            padding: 0 0.1em;
            animation: blink 1.5s infinite;
        }
        @keyframes blink {
            50% { opacity: 0.3; }
        }
        
        .timer-display .milliseconds {
            font-size: 0.5em;
            color: var(--accent-color);
            align-self: flex-end;
            margin-bottom: 0.5em; /* Align with bottom of main digits */
        }
        
        .timer-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .timer-input {
            width: clamp(70px, 18vw, 90px);
            padding: 10px;
            font-size: clamp(20px, 4vw, 24px);
            font-family: var(--font-family-body);
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: 10px;
            text-align: center;
        }
        
        .controls {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .control-btn {
            width: clamp(70px, 18vw, 90px);
            height: clamp(70px, 18vw, 90px);
            border-radius: 50%;
            border: none;
            font-size: clamp(18px, 3vw, 22px);
            font-weight: 600;
            font-family: var(--font-family-body);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 20px var(--shadow-color);
        }

        .control-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        #start-stop-btn {
            background-color: var(--secondary-color);
            color: white;
        }

        #start-stop-btn.running {
            background-color: var(--danger-color);
        }
        
        #lap-reset-btn {
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 2px solid var(--border-color);
        }
        
        .laps-container {
            width: 100%;
            max-width: 400px;
            margin-top: 20px;
        }

        .lap-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 15px;
            font-size: clamp(16px, 2.5vw, 20px);
            border-bottom: 1px solid var(--border-color);
            font-family: var(--font-family-body);
        }

        .lap-item:last-child {
            border-bottom: none;
        }
        
        /* ------------------- */
        /* --- History View (NEW TIME DETAILS) --- */
        /* ------------------- */
        .search-container {
            margin-bottom: 20px;
        }
        
        #history-search {
            width: 100%;
            padding: 12px 15px;
            font-size: clamp(16px, 2.5vw, 20px);
            font-family: var(--font-family-body);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background-color: var(--card-bg);
            color: var(--text-color);
            margin-top: 20px;
        }
        
        .history-list {
            list-style: none;
        }
        
        .history-item-wrapper {
            position: relative;
            margin-bottom: 12px;
            overflow: hidden;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .history-item-wrapper.is-pinned {
            box-shadow: 0 0 0 2px var(--pin-color), 0 5px 15px var(--shadow-color);
        }
        
        .history-item {
            background-color: var(--card-bg);
            box-shadow: 0 4px 15px var(--shadow-color);
            position: relative;
            touch-action: pan-y;
            transition: transform var(--transition-speed) ease;
            z-index: 2;
        }
        
        .history-item-content {
            padding: 15px;
            display: flex;
            flex-direction: column;
            background-color: var(--card-bg);
            border-radius: 12px;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* Align to top */
            margin-bottom: 10px;
            gap: 10px;
        }

        .history-item-label {
            font-weight: 600;
            font-size: clamp(20px, 3.5vw, 24px);
            word-break: break-word;
            margin-right: 10px;
        }
        .is-pinned .history-item-label::before {
            content: '\f08d'; /* Font Awesome pin icon */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: var(--pin-color);
            margin-right: 10px;
            font-size: 0.8em;
        }

        .history-item-duration {
            font-weight: 600;
            font-size: clamp(20px, 3.5vw, 24px);
            color: var(--primary-color);
            flex-shrink: 0;
            text-align: right;
        }
        
        .history-item-times { /* NEW for start/finish times */
            font-size: clamp(12px, 2vw, 16px);
            opacity: 0.7;
        }

        .history-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: clamp(14px, 2.2vw, 18px);
            color: var(--text-color);
            opacity: 0.7;
            margin-top: 10px; /* Added margin */
        }
        
        .project-tag {
            background-color: var(--accent-color);
            color: white;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: clamp(12px, 2vw, 16px);
            font-weight: 600;
        }

        .swipe-actions {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            display: flex;
            align-items: center;
            z-index: 1;
        }

        .swipe-btn {
            height: 100%;
            width: clamp(70px, 18vw, 80px);
            border: none;
            color: white;
            font-weight: 600;
            font-size: clamp(20px, 4vw, 24px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .swipe-btn span { font-size: 14px; margin-top: 4px; }
        
        .pin-btn { background-color: var(--pin-color); }
        .edit-btn { background-color: var(--accent-color); }
        .delete-btn { background-color: var(--danger-color); }
        .pin-btn:hover { background-color: #7b79f7; }
        .edit-btn:hover { background-color: #ffb84d; }
        .delete-btn:hover { background-color: #ff6b6b; }


        /* ------------------- */
        /* --- AI View (SUPER RESPONSIVE) --- */
        /* ------------------- */
        .ai-container {
            height: 100%; /* Fill the parent .view container */
            display: flex;
            flex-direction: column;
        }

        .ai-chat-log {
            flex-grow: 1; /* Take up all available vertical space */
            overflow-y: auto; /* Enable scrolling for chat messages */
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        .ai-message, .user-message {
            padding: 12px 18px;
            border-radius: 20px;
            max-width: 85%;
            word-wrap: break-word;
            font-size: clamp(16px, 2.5vw, 20px);
            animation: messageFadeIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        @keyframes messageFadeIn {
            from { opacity: 0; transform: translateY(15px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .user-message {
            background: var(--primary-gradient);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .ai-message {
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        .ai-message h3 { font-family: var(--font-family-display); margin-bottom: 10px; }
        .ai-message ul { list-style-position: inside; padding-left: 5px; }
        .ai-message li { margin-bottom: 5px; }
        
        .ai-message .data-actions button { /* NEW for export/import */
            margin-right: 10px;
            margin-top: 10px;
            padding: 8px 15px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-family: var(--font-family-body);
            font-weight: 600;
            font-size: 1em;
            background: var(--primary-gradient);
            color: white;
            transition: transform 0.2s ease;
        }
        .ai-message .data-actions button:active {
            transform: scale(0.95);
        }

        /* --- NEW: Today View & Goal Progress (REDESIGNED) --- */
        .today-view {
            border: 1px solid var(--border-color);
            border-left: 5px solid var(--primary-color);
            padding: 15px;
            background-color: var(--bg-color);
        }
        .today-view .greeting {
             font-family: var(--font-family-display);
             font-size: 1.2em;
             margin-bottom: 15px;
        }
        .goal-progress-item { margin-bottom: 12px; }
        .goal-progress-item label { display: block; font-weight: 600; margin-bottom: 4px; }
        .progress-bar-bg {
            width: 100%;
            height: 12px;
            background-color: var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }
        .progress-bar-fg {
            height: 100%;
            width: 0%;
            background: var(--primary-gradient);
            border-radius: 6px;
            transition: width 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .goal-progress-item .meta {
            font-size: 0.8em;
            display: flex;
            justify-content: space-between;
            opacity: 0.8;
            margin-top: 4px;
        }
        .stat-of-the-day {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed var(--border-color);
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* --- REDESIGNED AI SUGGESTIONS --- */
        .ai-suggestions {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            flex-wrap: nowrap;
            -ms-overflow-style: none;
            scrollbar-width: none;
            padding: 10px 0; /* Adjusted padding */
            margin-top: 5px;
            scroll-snap-type: x mandatory;
        }
        .ai-suggestions::-webkit-scrollbar { display: none; }

        .suggestion-btn {
            flex-shrink: 0;
            padding: 10px 18px;
            font-size: clamp(15px, 2.3vw, 18px);
            font-family: var(--font-family-body);
            font-weight: 500;
            border-radius: 18px;
            border: 1.5px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.25s ease-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            scroll-snap-align: start;
        }

        html.dark .suggestion-btn {
            background-color: transparent;
            color: var(--text-color);
        }

        .suggestion-btn:hover, .suggestion-btn:focus {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 122, 255, 0.4);
            border-color: var(--primary-color);
        }

        html.dark .suggestion-btn:hover, html.dark .suggestion-btn:focus {
            box-shadow: 0 0 25px rgba(10, 132, 255, 0.6);
            border-color: var(--primary-color);
        }


        .ai-command-container {
            flex-shrink: 0; /* Prevent container from shrinking */
            display: flex;
            gap: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }

        #ai-command-bar {
            flex-grow: 1;
            padding: 12px 15px;
            font-size: clamp(16px, 2.5vw, 20px);
            font-family: var(--font-family-body);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        #ai-command-submit {
            padding: 0 20px;
            border: none;
            background: var(--primary-gradient);
            color: white;
            font-weight: 600;
            font-family: var(--font-family-body);
            font-size: clamp(16px, 2.5vw, 20px);
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        #ai-command-submit:active {
            transform: scale(0.95);
        }
        
        #session-chart-container {
            margin-top: 15px;
            max-width: 100%;
        }
        
        /* ------------------- */
        /* --- Modals & Toasts --- */
        /* ------------------- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }
        
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            transform: scale(0.9) translateY(20px);
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.4s ease;
        }
        
        .modal-overlay.visible .modal-content {
            transform: scale(1) translateY(0);
            opacity: 1;
        }
        
        .modal-content h2 { 
            font-family: var(--font-family-display);
            margin-bottom: 20px; 
            font-size: clamp(22px, 4vw, 26px);
        }
        .modal-content p {
            margin-bottom: 25px;
            font-size: clamp(16px, 2.5vw, 20px);
            opacity: 0.8;
        }
        .modal-input {
            width: 100%;
            padding: 12px;
            font-size: clamp(16px, 2.5vw, 20px);
            font-family: var(--font-family-body);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 15px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        .modal-label {
            font-size: clamp(14px, 2.2vw, 18px);
            font-weight: 600;
            margin-bottom: 5px;
            display: block;
        }
        .project-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        #project-select { flex-grow: 1; }
        #new-project-input { flex-grow: 2; }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            font-family: var(--font-family-body);
            font-size: clamp(16px, 2.5vw, 20px);
            cursor: pointer;
        }
        
        .primary-btn { background: var(--primary-gradient); color: white; }
        .secondary-btn { background-color: var(--border-color); color: var(--text-color); }
        .danger-btn { background-color: var(--danger-color); color: white;}
        
        .toast-notification {
            position: fixed;
            bottom: calc(env(safe-area-inset-bottom) + 80px); /* Position above nav bar */
            left: 50%;
            transform: translateX(-50%);
            background-color: #2c2c2e;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            z-index: 3000;
            font-size: clamp(14px, 2.2vw, 18px);
            font-weight: 500;
            font-family: var(--font-family-body);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, transform 0.4s ease, visibility 0.4s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .toast-notification.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -10px);
        }

        /* Media Queries for larger screens */
        @media (min-width: 768px) {
            .view {
                max-width: 700px; /* Increase max-width for better desktop layout */
            }
             .ai-suggestions {
                margin-inline: 0;
                padding-inline: 0;
             }
        }
        
    </style>
</head>
<body>
    <div id="app-container">
        <header class="app-header">
            <h1>ChronoMind</h1>
            <button class="theme-toggle" id="theme-toggle-btn"><i class="fa-solid fa-sun"></i></button>
        </header>

        <main>
            <!-- Timer/Stopwatch View -->
            <div id="timer-view" class="view active">
                <div class="timer-container">
                    <div class="mode-switcher">
                        <button id="stopwatch-mode-btn" class="mode-btn active">Stopwatch</button>
                        <button id="timer-mode-btn" class="mode-btn">Timer</button>
                    </div>
                    
                    <div class="timer-display-wrapper">
                        <div class="timer-display">
                            <div class="digit-group" id="hours-group"></div>
                            <span class="separator">:</span>
                            <div class="digit-group" id="minutes-group"></div>
                            <span class="separator">:</span>
                            <div class="digit-group" id="seconds-group"></div>
                            <span class="milliseconds" id="ms-display">.000</span>
                        </div>
                    </div>

                    <div id="timer-input-wrapper" class="timer-input-container" style="display: none;">
                        <input type="number" id="hours-input" class="timer-input" placeholder="HH" min="0">
                        <span>:</span>
                        <input type="number" id="minutes-input" class="timer-input" placeholder="MM" min="0" max="59">
                        <span>:</span>
                        <input type="number" id="seconds-input" class="timer-input" placeholder="SS" min="0" max="59">
                    </div>

                    <div class="controls">
                        <button id="lap-reset-btn" class="control-btn">Lap</button>
                        <button id="start-stop-btn" class="control-btn">Start</button>
                    </div>
                </div>
                <div id="laps-container" class="laps-container"></div>
            </div>

            <!-- History View -->
            <div id="history-view" class="view">
                <div class="search-container">
                    <input type="search" id="history-search" placeholder="Search sessions by label or project...">
                </div>
                <ul class="history-list" id="history-list">
                    <!-- History items will be injected here -->
                </ul>
            </div>

            <!-- AI Assistant View -->
            <div id="ai-view" class="view">
                <div class="ai-container">
                    <div class="ai-chat-log" id="ai-chat-log">
                        <!-- AI and User messages will be injected here -->
                    </div>
                    <div>
                        <div class="ai-suggestions" id="ai-suggestions">
                             <!-- AI suggestions will be injected here -->
                        </div>
                        <div class="ai-command-container">
                            <input type="text" id="ai-command-bar" placeholder="Message ChronoMind AI...">
                            <button id="ai-command-submit"><i class="fa-solid fa-arrow-up"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <nav class="app-nav">
            <button class="nav-btn active" data-view="timer-view">
                <span class="icon"><i class="fa-solid fa-stopwatch-20"></i></span>
                <span>Timer</span>
            </button>
            <button class="nav-btn" data-view="history-view">
                <span class="icon"><i class="fa-solid fa-scroll"></i></span>
                <span>History</span>
            </button>
            <button class="nav-btn" data-view="ai-view">
                <span class="icon"><i class="fa-solid fa-brain"></i></span>
                <span>AI</span>
            </button>
        </nav>
    </div>

    <!-- Save/Edit Session Modal -->
    <div id="session-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title"><i class="fa-solid fa-pen-to-square"></i> Edit Session</h2>
            <label for="session-label-input" class="modal-label">Session Label</label>
            <input type="text" id="session-label-input" class="modal-input" placeholder="e.g., Morning Run">
            
            <label for="project-select" class="modal-label">Project</label>
            <div class="project-input-container">
                 <select id="project-select" class="modal-input">
                    <option value="">None</option>
                    <!-- Project options will be populated here -->
                </select>
                <input type="text" id="new-project-input" class="modal-input" placeholder="Or create new...">
            </div>

            <div class="modal-actions">
                <button id="delete-session-btn" class="modal-btn danger-btn" style="display: none; margin-right: auto;">Delete</button>
                <button id="cancel-session-btn" class="modal-btn secondary-btn">Cancel</button>
                <button id="save-session-btn" class="modal-btn primary-btn">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="confirmation-title"><i class="fa-solid fa-triangle-exclamation"></i> Are you sure?</h2>
            <p id="confirmation-message">This action cannot be undone.</p>
            <div class="modal-actions">
                <button id="confirmation-cancel-btn" class="modal-btn secondary-btn">Cancel</button>
                <button id="confirmation-confirm-btn" class="modal-btn danger-btn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="toast-notification"></div>

    <!-- Hidden file input for data import -->
    <input type="file" id="import-file-input" style="display: none;" accept="application/json">

    <!-- 
    ================================================================
    APPLICATION JAVASCRIPT
    ================================================================
    -->
    <script type="module">
        /**
         * @module App
         * @description Main application entry point. Initializes all modules,
         * handles state management, and renders the UI.
         */

        // --- UTILITY MODULE ---
        const Utils = {
            formatTime(ms, showMilliseconds = true, showMsSeparator = true) {
                if (ms < 0) ms = 0;
                const totalSeconds = Math.floor(ms / 1000);
                const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
                const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
                const seconds = String(totalSeconds % 60).padStart(2, '0');
                if (showMilliseconds) {
                    const milliseconds = String(ms % 1000).padStart(3, '0');
                    return { full: `${hours}:${minutes}:${seconds}`, ms: `${showMsSeparator ? '.' : ''}${milliseconds}`, parts: {hours, minutes, seconds} };
                }
                return { full: `${hours}:${minutes}:${seconds}`, ms: '', parts: {hours, minutes, seconds} };
            },
            formatDateTime(isoString) {
                if (!isoString) return '';
                const date = new Date(isoString);
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            },
            generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            },
            debounce(func, delay) {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            },
            parseTimeToMs(timeString) {
                const timeRegex = /(?:(\d+)\s*h(?:our)?s?)?\s*(?:(\d+)\s*m(?:in(?:ute)?)?s?)?\s*(?:(\d+)\s*s(?:ec(?:ond)?)?s?)?/;
                const match = timeString.toLowerCase().match(timeRegex);
                if (!match) return 0;
                
                const [, hours, minutes, seconds] = match.map(v => parseInt(v) || 0);
                return (hours * 3600 + minutes * 60 + seconds) * 1000;
            }
        };
        
        // --- SOUND ENGINE ---
        const SoundEngine = {
            audioContext: null,
            init() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            },
            playNotification() {
                if (!this.audioContext) this.init();
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.5, this.audioContext.currentTime + 0.05);

                oscillator.frequency.setValueAtTime(880, this.audioContext.currentTime);
                oscillator.type = 'sine';
                
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + 0.2);
                
                gainNode.gain.exponentialRampToValueAtTime(0.00001, this.audioContext.currentTime + 0.2);
            }
        };

        // --- LOCAL STORAGE & STATE MANAGEMENT ---
        const Store = {
            _state: {
                theme: 'light',
                history: [],
                projects: [],
                goals: {}, // { projectId: { frequency: 'daily'/'weekly', duration: ms } }
                userStats: { // EXPANDED for long-term memory
                    lastAiWelcome: null,
                    userName: null,
                    commonDurations: {}, // { '25': 10, '60': 5 } (minutes: count)
                    commonProjects: {}, // { projectId: count }
                    peakHour: null,
                    productiveDay: null,
                },
            },
            init() {
                const savedState = localStorage.getItem('chronoMindState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    // Deep merge to prevent new properties from being overwritten by old state
                    this._state = {
                        ...this._state,
                        ...parsedState,
                        userStats: { ...this._state.userStats, ...(parsedState.userStats || {}) }
                    };
                }
                this._state.history.sort((a, b) => (b.isPinned - a.isPinned) || (new Date(b.timestamp) - new Date(a.timestamp)));
                this.save(false); // don't dispatch event on initial load
            },
            getState() { return this._state; },
            getHistory() { return this._state.history; },
            getProjects() { return this._state.projects; },
            getGoals() { return this._state.goals; },

            addHistory(session) {
                this._state.history.unshift(session);
                this._state.history.sort((a, b) => (b.isPinned - a.isPinned) || (new Date(b.timestamp) - new Date(a.timestamp)));
                this.save();
            },
            updateHistory(id, newLabel, newProjectId) {
                const session = this._state.history.find(s => s.id === id);
                if (session) {
                    session.label = newLabel;
                    session.projectId = newProjectId;
                    this.save();
                }
            },
            deleteHistory(id) {
                this._state.history = this._state.history.filter(s => s.id !== id);
                this.save();
            },
            togglePin(id) {
                const session = this._state.history.find(s => s.id === id);
                if (session) {
                    session.isPinned = !session.isPinned;
                    this._state.history.sort((a, b) => (b.isPinned - a.isPinned) || (new Date(b.timestamp) - new Date(a.timestamp)));
                    this.save();
                }
            },
            addProject(projectName) {
                const newProject = { id: Utils.generateUUID(), name: projectName };
                this._state.projects.push(newProject);
                this.save();
                return newProject;
            },
            setGoal(projectId, frequency, duration) {
                 this._state.goals[projectId] = { frequency, duration };
                 this.save();
            },
            setTheme(theme) {
                this._state.theme = theme;
                this.save();
            },
            updateUserStat(key, value) {
                this._state.userStats[key] = value;
                this.save();
            },
            replaceState(newState) { // NEW for import
                // Basic validation and default-filling for backward compatibility
                this._state = {
                    theme: newState.theme || 'light',
                    history: newState.history || [],
                    projects: newState.projects || [],
                    goals: newState.goals || {},
                    userStats: {
                        ...{
                            lastAiWelcome: null,
                            userName: null,
                            commonDurations: {},
                            commonProjects: {},
                            peakHour: null,
                            productiveDay: null,
                        },
                        ...(newState.userStats || {})
                    },
                };
                this._state.history.sort((a, b) => (b.isPinned - a.isPinned) || (new Date(b.timestamp) - new Date(a.timestamp)));
                this.save();
            },
            save(dispatchEvent = true) {
                const stateString = JSON.stringify(this._state);
                localStorage.setItem('chronoMindState', stateString);
                if (dispatchEvent) {
                    // Use a custom event to avoid conflicts and provide more detail
                    window.dispatchEvent(new CustomEvent('chronoMindStorageUpdated', { detail: { state: this._state }}));
                }
            },
        };

        // --- CONFIRMATION MODAL MANAGER ---
        const ConfirmationModal = {
            _modal: null,
            _message: null,
            _confirmBtn: null,
            _cancelBtn: null,
            _resolvePromise: null,
            _rejectPromise: null,

            init() {
                this._modal = document.getElementById('confirmation-modal');
                this._message = document.getElementById('confirmation-message');
                this._confirmBtn = document.getElementById('confirmation-confirm-btn');
                this._cancelBtn = document.getElementById('confirmation-cancel-btn');

                this._confirmBtn.addEventListener('click', () => this.confirm());
                this._cancelBtn.addEventListener('click', () => this.cancel());
                this._modal.addEventListener('click', (e) => {
                    if (e.target === this._modal) this.cancel();
                });
            },

            show(message = "Are you sure?") {
                this._message.textContent = message;
                this._modal.classList.add('visible');
                return new Promise((resolve, reject) => {
                    this._resolvePromise = resolve;
                    this._rejectPromise = reject;
                });
            },
            
            hide() {
                this._modal.classList.remove('visible');
            },

            confirm() {
                if (this._resolvePromise) {
                    this._resolvePromise();
                }
                this.hide();
            },

            cancel() {
                if (this._rejectPromise) {
                    this._rejectPromise(new Error('User cancelled the action.'));
                }
                this.hide();
            }
        };

        // --- TIMER ENGINE ---
        class TimerEngine {
            constructor(updateCallback, finishedCallback) {
                this.isRunning = false;
                this.mode = 'stopwatch'; // 'stopwatch' or 'timer'
                this.startTime = 0;
                this.elapsedTime = 0;
                this.lapStartTime = 0;
                this.laps = [];
                this.timerDuration = 0;
                this.animationFrameId = null;
                this.updateCallback = updateCallback;
                this.finishedCallback = finishedCallback;
                this.pendingSession = null;
                this.sessionStartTime = null; // NEW
            }

            start() {
                if (this.isRunning) return;
                this.isRunning = true;
                this.startTime = performance.now() - this.elapsedTime;
                this.lapStartTime = this.startTime;
                if (this.elapsedTime === 0) { // Only set on fresh start
                    this.sessionStartTime = new Date().toISOString();
                }
                this.tick();
            }

            stop() {
                if (!this.isRunning) return;
                this.isRunning = false;
                cancelAnimationFrame(this.animationFrameId);
                this.elapsedTime = performance.now() - this.startTime;
                const duration = this.mode === 'stopwatch' ? this.elapsedTime : this.timerDuration;
                if (duration > 1000) { // Only save sessions longer than a second
                    this.pendingSession = {
                        duration,
                        type: this.mode,
                        laps: [...this.laps],
                        startTime: this.sessionStartTime, // NEW
                        finishTime: new Date().toISOString(), // NEW
                    };
                }
                document.title = 'ChronoMind AI'; // Reset title
            }
            
            lap() {
                if (!this.isRunning || this.mode !== 'stopwatch') return;
                const now = performance.now();
                const lapTime = now - this.lapStartTime;
                this.laps.unshift({ time: lapTime });
                this.lapStartTime = now;
            }

            reset() {
                if (this.isRunning) this.stop();
                this.elapsedTime = 0;
                this.laps = [];
                this.timerDuration = 0;
                this.pendingSession = null;
                this.sessionStartTime = null; // NEW
                this.updateCallback(0);
                document.title = 'ChronoMind AI'; // Reset title
            }
            
            setTimer(duration) {
                this.reset();
                this.mode = 'timer';
                this.timerDuration = duration;
                this.elapsedTime = 0;
                this.updateCallback(duration);
            }

            tick() {
                if (!this.isRunning) return;
                
                const now = performance.now();
                this.elapsedTime = now - this.startTime;
                
                let displayTime = this.mode === 'stopwatch' ? this.elapsedTime : this.timerDuration - this.elapsedTime;

                if (displayTime < 0) displayTime = 0;
                
                this.updateCallback(displayTime);
                
                // Update page title for "Live Activity" effect
                const { full } = Utils.formatTime(displayTime, false);
                document.title = `${full} - ChronoMind`;

                if (this.mode === 'timer' && displayTime <= 0) {
                    this.stop();
                    this.finishedCallback(); // Use the callback
                    if (this.pendingSession) {
                        document.dispatchEvent(new CustomEvent('timer-finished'));
                    }
                }
                
                this.animationFrameId = requestAnimationFrame(this.tick.bind(this));
            }
        }
        
        // --- AI MODULE (PRECOGNITIVE & PERSONALIZED) ---
        const AI = {
            processCommand(command) {
                command = command.toLowerCase().trim();
                let match;

                // Rule: My name is... (NEW)
                match = command.match(/my name is (.+)/);
                if (match) return { intent: 'set_name', name: match[1].trim() };
                
                // Rule: What do you know about me? (NEW)
                match = command.match(/what do you know about me|summarize my habits/);
                if (match) return { intent: 'summarize_habits' };

                // Rule: Start timer/stopwatch (flexible with projects)
                match = command.match(/^start (?:a )?(stopwatch|timer)?(?: for )?(.+?)(?: for (.+))?$/);
                if (match) {
                    let [, type, time, project] = match;
                    if (time === 'stopwatch' || type === 'stopwatch') {
                         return { intent: 'start_stopwatch', project: project || time || null };
                    }
                    const duration = Utils.parseTimeToMs(time);
                    if (duration > 0) return { intent: 'start_timer', duration, project: project || null };
                }
                if (command === 'start stopwatch') return { intent: 'start_stopwatch', project: null };
                
                // Rule: Set a goal (UPGRADED for recurrence)
                match = command.match(/set (?:a )?(daily|weekly|monthly)?(?: )?goal of (.+?) for (.+)/);
                if(match) {
                    const [, frequency = 'daily', time, projectName] = match;
                    const duration = Utils.parseTimeToMs(time);
                    if(duration > 0) return { intent: 'set_goal', frequency, duration, projectName };
                }
                
                // Rule: Show data (enhanced)
                match = command.match(/show (?:me )?(?:my )?(.+)/);
                if (match) {
                    const query = match[1];
                    if (query.includes('progress') || query.includes('today')) return { intent: 'show_progress_today' };
                    if (query === 'summary' || query === 'stats') return { intent: 'get_summary' };
                    if (query.includes('this week vs last week')) return { intent: 'compare_weeks' };
                    return { intent: 'filter_history', filter: query };
                }

                // Rule: Delete last session
                match = command.match(/delete (?:my )?(last|latest) session/);
                if(match) return { intent: 'delete_last_session' };
                
                // Rule: Data Management (NEW)
                if (command.includes('export my data')) return { intent: 'export_data' };
                if (command.includes('import data')) return { intent: 'import_data' };

                // Rule: General question (enhanced)
                 match = command.match(/^(what is|what's|how many|how much)/);
                if (match) {
                    if (command.includes('average')) return { intent: 'get_insight', insight: 'average' };
                    if (command.includes('productive day')) return { intent: 'get_insight', insight: 'productive_day' };
                    if (command.includes('most active project')) return { intent: 'get_insight', insight: 'active_project' };
                    if (command.includes('total time')) return { intent: 'get_insight', insight: 'total_time' };
                }
                
                // Rule: Coaching/Productivity
                match = command.match(/suggest a (task|break|goal)/); // Added goal
                if(match) return { intent: 'suggest', type: match[1] };

                return { intent: 'unknown' };
            },

            analyzeHistory(history, projects, goals) {
                if (!history || history.length === 0) {
                    return { summary: "No sessions recorded yet. Start a timer to begin!", insights: [], chartData: null, goalProgress: [], statOfTheDay: "Let's get started!", peakHour: null, productiveDay: null };
                }
                
                const totalSessions = history.length;
                const totalTimeMs = history.reduce((sum, s) => sum + s.duration, 0);
                const avgTimeMs = totalTimeMs / totalSessions;

                const summary = `You've completed <strong>${totalSessions}</strong> sessions, totaling <strong>${Utils.formatTime(totalTimeMs, false).full}</strong>. Avg. session: <strong>${Utils.formatTime(avgTimeMs, false).full}</strong>.`;
                
                // --- INSIGHTS ---
                const insights = [];
                // Most productive day
                const sessionsByDay = history.reduce((acc, s) => {
                    const day = new Date(s.timestamp).toLocaleDateString('en-US', { weekday: 'long' });
                    acc[day] = (acc[day] || 0) + s.duration;
                    return acc;
                }, {});
                const productiveDay = Object.keys(sessionsByDay).sort((a,b) => sessionsByDay[b] - sessionsByDay[a])[0];
                if(productiveDay) insights.push(`Your most productive day is <strong>${productiveDay}</strong>.`);

                // Most active project
                const timeByProject = history.reduce((acc, s) => {
                    if (s.projectId) acc[s.projectId] = (acc[s.projectId] || 0) + s.duration;
                    return acc;
                }, {});
                const mostActiveProjectId = Object.keys(timeByProject).sort((a,b) => timeByProject[b] - timeByProject[a])[0];
                if (mostActiveProjectId) {
                    const projectName = projects.find(p => p.id === mostActiveProjectId)?.name || 'Unknown';
                    insights.push(`Your most active project is <strong>${projectName}</strong>.`);
                }
                
                // Peak Productivity Hour
                const sessionsByHour = history.reduce((acc, s) => {
                    const hour = new Date(s.timestamp).getHours(); // 0-23
                    acc[hour] = (acc[hour] || 0) + s.duration;
                    return acc;
                }, {});
                const peakHour = Object.keys(sessionsByHour).sort((a,b) => sessionsByHour[b] - sessionsByHour[a])[0];
                if(peakHour) {
                    const ampm = peakHour >= 12 ? 'PM' : 'AM';
                    const displayHour = peakHour % 12 || 12;
                    insights.push(`You're most active around <strong>${displayHour} ${ampm}</strong>.`);
                }
                
                const statOfTheDay = insights[Math.floor(Math.random() * insights.length)] || "Keep up the great work!";


                // --- GOAL PROGRESS ---
                const goalProgress = [];
                const now = new Date();
                
                for(const projectId in goals) {
                    const goal = goals[projectId];
                    const project = projects.find(p => p.id === projectId);
                    if (!project) continue;
                    
                    let startOfPeriod;
                    if(goal.frequency === 'daily') {
                        startOfPeriod = new Date().setHours(0,0,0,0);
                    } else if (goal.frequency === 'weekly') {
                        const dayOfWeek = now.getDay(); // Sunday - 0, Monday - 1..
                        const firstDayOfWeek = new Date(now.setDate(now.getDate() - dayOfWeek));
                        startOfPeriod = firstDayOfWeek.setHours(0,0,0,0);
                    } else { // monthly
                        startOfPeriod = new Date(now.getFullYear(), now.getMonth(), 1).setHours(0,0,0,0);
                    }

                    const timeInPeriod = history
                        .filter(s => s.projectId === projectId && new Date(s.timestamp) >= startOfPeriod)
                        .reduce((sum, s) => sum + s.duration, 0);
                        
                    goalProgress.push({
                        projectName: project.name,
                        frequency: goal.frequency,
                        timeTracked: timeInPeriod,
                        goalDuration: goal.duration,
                        percentage: Math.min(100, (timeInPeriod / goal.duration) * 100),
                    });
                }

                // --- CHART DATA ---
                const last7DaysData = {};
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    const key = d.toLocaleDateString('en-CA');
                    last7DaysData[key] = 0;
                }
                history.forEach(session => {
                    const sessionDate = new Date(session.timestamp).toLocaleDateString('en-CA');
                    if(last7DaysData.hasOwnProperty(sessionDate)) {
                        last7DaysData[sessionDate] += session.duration / (1000 * 60);
                    }
                });
                const chartData = {
                    type: 'bar',
                    labels: Object.keys(last7DaysData).map(d => new Date(d).toLocaleDateString('en-US', { weekday: 'short' })),
                    datasets: [{
                        label: 'Minutes per Day',
                        data: Object.values(last7DaysData),
                        backgroundColor: 'rgba(10, 132, 255, 0.6)',
                        borderColor: 'rgba(10, 132, 255, 1)',
                        borderWidth: 1, borderRadius: 5,
                    }]
                };

                return { summary, insights, chartData, goalProgress, statOfTheDay, peakHour, productiveDay };
            },

            compareWeeks(history) {
                const now = new Date();
                const today = now.getDay(); // 0 (Sun) - 6 (Sat)
                
                const endOfThisWeek = new Date();
                endOfThisWeek.setHours(23,59,59,999);

                const startOfThisWeek = new Date();
                startOfThisWeek.setDate(now.getDate() - today);
                startOfThisWeek.setHours(0,0,0,0);
                
                const startOfLastWeek = new Date(startOfThisWeek);
                startOfLastWeek.setDate(startOfThisWeek.getDate() - 7);

                const endOfLastWeek = new Date(startOfThisWeek);
                endOfLastWeek.setDate(startOfThisWeek.getDate() - 1);
                endOfLastWeek.setHours(23,59,59,999);


                const thisWeekTime = history
                    .filter(s => new Date(s.timestamp) >= startOfThisWeek && new Date(s.timestamp) <= endOfThisWeek)
                    .reduce((sum, s) => sum + s.duration, 0);

                const lastWeekTime = history
                    .filter(s => new Date(s.timestamp) >= startOfLastWeek && new Date(s.timestamp) <= endOfLastWeek)
                    .reduce((sum, s) => sum + s.duration, 0);
                
                const difference = thisWeekTime - lastWeekTime;
                const percentageChange = lastWeekTime > 0 ? (difference / lastWeekTime) * 100 : (thisWeekTime > 0 ? 100 : 0);

                let analysis = `This week so far: <strong>${Utils.formatTime(thisWeekTime, false).full}</strong>.<br>Last week total: <strong>${Utils.formatTime(lastWeekTime, false).full}</strong>.<br>`;
                
                if (difference > 0) {
                    analysis += `You're up by <strong>${Utils.formatTime(difference, false).full}</strong> (+${percentageChange.toFixed(0)}%)! Fantastic work!`;
                } else if (difference < 0) {
                     analysis += `You're down by <strong>${Utils.formatTime(Math.abs(difference), false).full}</strong> (${percentageChange.toFixed(0)}%). Let's pick up the pace!`;
                } else {
                    analysis += "You're on the same pace as last week. Keep it consistent!";
                }

                return analysis;
            },
            
            generateSuggestions(state) { // UPGRADED to be smarter
                const suggestions = new Set();
                const { userStats, projects } = state;

                // Personalized start command
                if (Object.keys(userStats.commonProjects).length > 0) {
                    const mostCommonProjectId = Object.keys(userStats.commonProjects).sort((a,b) => userStats.commonProjects[b] - userStats.commonProjects[a])[0];
                    const mostCommonProject = projects.find(p => p.id === mostCommonProjectId);
                    if (mostCommonProject) {
                         suggestions.add(`Start timer for ${mostCommonProject.name}`);
                    }
                } else {
                     suggestions.add('Start a 15 minute timer');
                }

                suggestions.add('Show my summary');
                suggestions.add('Compare this week vs last week');
                
                if(Object.keys(state.goals).length > 0) suggestions.add("What's my goal progress?");
                
                if (!userStats.userName) {
                    suggestions.add("My name is...");
                } else {
                    suggestions.add("Summarize my habits");
                }
                
                return Array.from(suggestions).slice(0, 4);
            },
            
            generateTodayView(state) {
                const now = new Date();
                const hour = now.getHours();
                const userName = state.userStats.userName;
                let greeting = "Hello" + (userName ? `, ${userName}` : "!");
                if (hour < 12) greeting = "Good morning" + (userName ? `, ${userName}` : "!");
                else if (hour < 18) greeting = "Good afternoon" + (userName ? `, ${userName}` : "!");
                else greeting = "Good evening" + (userName ? `, ${userName}` : "!");

                const { goalProgress, statOfTheDay } = this.analyzeHistory(state.history, state.projects, state.goals);

                let goalHtml = "<h3><i class='fa-solid fa-bullseye'></i> Goal Progress</h3>";
                if (goalProgress.length > 0) {
                    goalHtml += goalProgress.map(p => `
                        <div class="goal-progress-item">
                            <label>${p.projectName} (${p.frequency})</label>
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fg" style="width: 0%;" data-percent="${p.percentage.toFixed(0)}"></div>
                            </div>
                             <div class="meta">
                                <span>${Utils.formatTime(p.timeTracked, false).full} / ${Utils.formatTime(p.goalDuration, false).full}</span>
                                <span>${p.percentage.toFixed(0)}%</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    goalHtml += "<p style='opacity: 0.7; font-size: 0.9em;'>No goals set. Try 'Set a daily goal of 1 hour for work'.</p>";
                }
                
                return `
                    <div class="today-view">
                        <div class="greeting">${greeting} Here's your status for today.</div>
                        ${goalHtml}
                        <div class="stat-of-the-day">
                            <strong><i class='fa-solid fa-star'></i> Insight of the Day:</strong> ${statOfTheDay}
                        </div>
                    </div>
                `;
            },
            getMotivationalFeedback() {
                const phrases = [
                    "Great session! Keep the momentum going.",
                    "Excellent focus. That's how progress is made!",
                    "Job well done. What's next?",
                    "Another productive session in the books. Awesome!",
                    "You're on fire! Keep it up."
                ];
                return phrases[Math.floor(Math.random() * phrases.length)];
            },
            updateLearnings(state, session) { // NEW: Core of long-term memory
                const { userStats } = state;
                
                // Learn common project
                if (session.projectId) {
                    userStats.commonProjects[session.projectId] = (userStats.commonProjects[session.projectId] || 0) + 1;
                }
                
                // Learn common duration
                const durationMinutes = Math.round(session.duration / 60000);
                if(durationMinutes > 0){
                    userStats.commonDurations[durationMinutes] = (userStats.commonDurations[durationMinutes] || 0) + 1;
                }

                // Re-analyze and store peak times
                const { peakHour, productiveDay } = this.analyzeHistory(state.history, state.projects, state.goals);
                userStats.peakHour = peakHour;
                userStats.productiveDay = productiveDay;

                // No need to call Store.updateUserStat for each, just let the next save handle it.
            }
        };
        
        // --- NOTIFICATION MANAGER ---
        const NotificationManager = {
            isPermissionGranted: false,
            async requestPermission() {
                if (!("Notification" in window)) {
                    console.log("This browser does not support desktop notification");
                    return;
                }
                if (Notification.permission === "granted") {
                    this.isPermissionGranted = true;
                } else if (Notification.permission !== "denied") {
                    const permission = await Notification.requestPermission();
                    this.isPermissionGranted = permission === "granted";
                }
            },
            show(title, body) {
                if (this.isPermissionGranted) {
                    new Notification(title, { body });
                }
            }
        };

        // --- UI MANAGER & MAIN APP LOGIC ---
        class App {
            constructor() {
                this.timerEngine = new TimerEngine(
                    this.updateTimeDisplay.bind(this),
                    this.handleTimerFinished.bind(this)
                );
                this.currentView = 'timer-view';
                this.editingSession = null; // {id, type: 'new' or 'edit'}
                this.sessionChart = null;
                this.lastTimeParts = {}; // For animated display

                Store.init();
                ConfirmationModal.init();
                this.cacheDOMElements();
                this.setupAnimatedDisplay();
                this.bindEventListeners();
                
                NotificationManager.requestPermission(); // Request on load
                this.applyTheme();
                this.renderHistory();
            }

            cacheDOMElements() {
                this.dom = {
                    html: document.documentElement,
                    themeToggleBtn: document.getElementById('theme-toggle-btn'),
                    navBtns: document.querySelectorAll('.nav-btn'),
                    views: document.querySelectorAll('.view'),
                    hoursGroup: document.getElementById('hours-group'),
                    minutesGroup: document.getElementById('minutes-group'),
                    secondsGroup: document.getElementById('seconds-group'),
                    msDisplay: document.getElementById('ms-display'),
                    startStopBtn: document.getElementById('start-stop-btn'),
                    lapResetBtn: document.getElementById('lap-reset-btn'),
                    stopwatchModeBtn: document.getElementById('stopwatch-mode-btn'),
                    timerModeBtn: document.getElementById('timer-mode-btn'),
                    timerInputWrapper: document.getElementById('timer-input-wrapper'),
                    hoursInput: document.getElementById('hours-input'),
                    minutesInput: document.getElementById('minutes-input'),
                    secondsInput: document.getElementById('seconds-input'),
                    lapsContainer: document.getElementById('laps-container'),
                    historyList: document.getElementById('history-list'),
                    historySearch: document.getElementById('history-search'),
                    sessionModal: document.getElementById('session-modal'),
                    modalTitle: document.getElementById('modal-title'),
                    sessionLabelInput: document.getElementById('session-label-input'),
                    projectSelect: document.getElementById('project-select'),
                    newProjectInput: document.getElementById('new-project-input'),
                    saveSessionBtn: document.getElementById('save-session-btn'),
                    cancelSessionBtn: document.getElementById('cancel-session-btn'),
                    deleteSessionBtn: document.getElementById('delete-session-btn'),
                    toast: document.getElementById('toast-notification'),
                    aiCommandBar: document.getElementById('ai-command-bar'),
                    aiCommandSubmit: document.getElementById('ai-command-submit'),
                    aiChatLog: document.getElementById('ai-chat-log'),
                    aiSuggestions: document.getElementById('ai-suggestions'),
                    importFileInput: document.getElementById('import-file-input'), // NEW
                };
            }

            bindEventListeners() {
                this.dom.themeToggleBtn.addEventListener('click', this.toggleTheme.bind(this));
                this.dom.navBtns.forEach(btn => btn.addEventListener('click', () => this.switchView(btn.dataset.view)));
                
                this.dom.startStopBtn.addEventListener('click', this.handleStartStop.bind(this));
                this.dom.lapResetBtn.addEventListener('click', this.handleLapReset.bind(this));
                
                this.dom.stopwatchModeBtn.addEventListener('click', () => this.switchMode('stopwatch'));
                this.dom.timerModeBtn.addEventListener('click', () => this.switchMode('timer'));

                this.dom.historySearch.addEventListener('input', Utils.debounce(this.renderHistory.bind(this), 300));

                this.dom.sessionModal.addEventListener('click', (e) => { if (e.target === this.dom.sessionModal) this.closeSessionModal(); });
                this.dom.saveSessionBtn.addEventListener('click', this.handleSaveSession.bind(this));
                this.dom.cancelSessionBtn.addEventListener('click', this.closeSessionModal.bind(this));
                this.dom.deleteSessionBtn.addEventListener('click', this.handleDeleteSession.bind(this));
                
                document.addEventListener('timer-finished', () => this.openSessionModal('new'));

                this.dom.aiCommandSubmit.addEventListener('click', this.handleAICommand.bind(this));
                this.dom.aiCommandBar.addEventListener('keydown', (e) => { if (e.key === 'Enter') this.handleAICommand(); });
                
                this.dom.importFileInput.addEventListener('change', this.handleImportData.bind(this)); // NEW

                // Cross-tab sync listener
                window.addEventListener('chronoMindStorageUpdated', (e) => {
                    Store.init(); // Re-init to get the latest state from localStorage
                    this.applyTheme();
                    // Re-render views if they are active to reflect changes
                    if (this.currentView === 'history-view') this.renderHistory();
                    if (this.currentView === 'ai-view') this.initAIView();
                });
            }

            // --- Theme ---
            toggleTheme() {
                const newTheme = this.dom.html.classList.contains('dark') ? 'light' : 'dark';
                Store.setTheme(newTheme);
                this.applyTheme();
            }

            applyTheme() {
                const theme = Store.getState().theme;
                this.dom.html.classList.toggle('dark', theme === 'dark');
                this.dom.themeToggleBtn.innerHTML = theme === 'dark' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
            }

            // --- Navigation ---
            switchView(viewId) {
                if (this.currentView === viewId) return;
                this.currentView = viewId;
                
                this.dom.views.forEach(view => view.classList.remove('active'));
                document.getElementById(viewId).classList.add('active');

                this.dom.navBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.view === viewId));

                if (viewId === 'history-view') this.renderHistory();
                if (viewId === 'ai-view') this.initAIView();
            }
            
            // --- AI View Logic ---
            initAIView() {
                const lastWelcome = Store.getState().userStats.lastAiWelcome;
                const today = new Date().toLocaleDateString();

                if (this.dom.aiChatLog.children.length === 0 || lastWelcome !== today) {
                     this.dom.aiChatLog.innerHTML = ''; // Clear chat for fresh welcome
                     const todayViewHtml = AI.generateTodayView(Store.getState());
                     this.renderAIMessage(todayViewHtml, (el) => {
                         // Animate progress bars after rendering
                         el.querySelectorAll('.progress-bar-fg').forEach(bar => {
                            setTimeout(() => bar.style.width = bar.dataset.percent + '%', 100);
                         });
                     });
                     Store.updateUserStat('lastAiWelcome', today);
                }
                this.renderAISuggestions();
            }

            renderAISuggestions() {
                const suggestions = AI.generateSuggestions(Store.getState());
                this.dom.aiSuggestions.innerHTML = suggestions.map(s => `<button class="suggestion-btn">${s}</button>`).join('');
                this.dom.aiSuggestions.querySelectorAll('.suggestion-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.dom.aiCommandBar.value = btn.textContent;
                        this.handleAICommand();
                    });
                });
            }

            handleAICommand() {
                const command = this.dom.aiCommandBar.value;
                if (!command) return;

                this.renderUserMessage(command);
                this.dom.aiCommandBar.value = '';

                const state = Store.getState();
                const result = AI.processCommand(command);
                
                setTimeout(() => {
                    switch(result.intent) {
                        case 'set_name': {
                            const name = result.name.charAt(0).toUpperCase() + result.name.slice(1);
                            Store.updateUserStat('userName', name);
                            this.renderAIMessage(`Nice to meet you, ${name}! I'll remember that.`);
                            break;
                        }
                        case 'summarize_habits': {
                            const { userName, productiveDay, peakHour, commonProjects } = state.userStats;
                            let html = `<h3>Here's what I've learned about you${userName ? ', ' + userName : ''}:</h3><ul>`;
                            if (productiveDay) html += `<li>Your most productive day seems to be <strong>${productiveDay}</strong>.</li>`;
                            if (peakHour) {
                                const ampm = peakHour >= 12 ? 'PM' : 'AM';
                                const displayHour = peakHour % 12 || 12;
                                html += `<li>You do your best work around <strong>${displayHour} ${ampm}</strong>.</li>`;
                            }
                            if (Object.keys(commonProjects).length > 0) {
                                const mostCommonProjectId = Object.keys(commonProjects).sort((a,b) => commonProjects[b] - commonProjects[a])[0];
                                const projectName = state.projects.find(p => p.id === mostCommonProjectId)?.name || 'a specific project';
                                html += `<li>You frequently work on <strong>${projectName}</strong>.</li>`;
                            }
                            if (html.endsWith('<ul>')) {
                                html += "<li>I'm still learning about your habits. Keep tracking sessions to get more personalized insights!</li>";
                            }
                            html += '</ul>';
                            this.renderAIMessage(html);
                            break;
                        }
                        case 'start_stopwatch': {
                            this.switchMode('stopwatch', false);
                            if (!this.timerEngine.isRunning) {
                                this.handleStartStop();
                            }
                            this.renderAIMessage("Stopwatch started. Let's make it count!");
                            this.switchView('timer-view');
                            break;
                        }
                        case 'start_timer': {
                            this.switchMode('timer', false);
                            const h = Math.floor(result.duration / 3600000);
                            const m = Math.floor((result.duration % 3600000) / 60000);
                            const s = Math.floor((result.duration % 60000) / 1000);
                            this.dom.hoursInput.value = h > 0 ? h : '';
                            this.dom.minutesInput.value = m > 0 ? m : '';
                            this.dom.secondsInput.value = s > 0 ? s : '';

                            this.timerEngine.setTimer(result.duration);
                            if (!this.timerEngine.isRunning) {
                                this.handleStartStop();
                            }
                            
                            let response = `Okay, starting a ${Utils.formatTime(result.duration, false).full} timer. Time to focus!`;
                            if (result.project) {
                                let project = state.projects.find(p => p.name.toLowerCase() === result.project.toLowerCase());
                                if (!project) {
                                    project = Store.addProject(result.project);
                                    this.showToast(`New project created: ${result.project}`);
                                }
                                this.timerEngine.pendingSession = { ...this.timerEngine.pendingSession, projectId: project.id };
                            }
                            this.renderAIMessage(response);
                            this.switchView('timer-view');
                            break;
                        }
                        case 'set_goal': {
                            const { projectName, frequency, duration } = result;
                             let project = state.projects.find(p => p.name.toLowerCase() === projectName.toLowerCase());
                            if (!project) {
                                project = Store.addProject(projectName);
                                this.showToast(`New project created: ${projectName}`);
                            }
                            Store.setGoal(project.id, frequency, duration);
                            this.renderAIMessage(`Got it. I've set a ${frequency} goal of ${Utils.formatTime(duration, false).full} for "${project.name}".`);
                            break;
                        }
                        case 'get_summary': {
                             const { summary, insights, chartData } = AI.analyzeHistory(state.history, state.projects, state.goals);
                             let html = `<h3><i class="fa-solid fa-chart-simple"></i> Session Summary</h3>${summary}<br><h3><i class="fa-solid fa-lightbulb"></i> Insights:</h3><ul>${insights.map(i => `<li>${i}</li>`).join('')}</ul>`;
                             html += `<div id="chart-container-${Date.now()}" style="margin-top:15px;"><canvas></canvas></div>`;
                             this.renderAIMessage(html, (el) => this.renderChartInMessage(el, chartData));
                            break;
                        }
                        case 'compare_weeks': {
                             const analysis = AI.compareWeeks(state.history);
                             this.renderAIMessage(`<h3><i class="fa-solid fa-calendar-week"></i> Weekly Comparison</h3>${analysis}`);
                            break;
                        }
                        case 'show_progress_today': {
                             const todayViewHtml = AI.generateTodayView(Store.getState());
                             this.renderAIMessage(todayViewHtml, (el) => {
                                 el.querySelectorAll('.progress-bar-fg').forEach(bar => {
                                    setTimeout(() => bar.style.width = bar.dataset.percent + '%', 100);
                                 });
                             });
                            break;
                        }
                        case 'get_insight': {
                            const { insights } = AI.analyzeHistory(state.history, state.projects, state.goals);
                            const insightMap = {
                                average: `Your average session is <strong>${Utils.formatTime(state.history.reduce((a,b) => a + b.duration, 0) / state.history.length, false).full}</strong>.`,
                                productive_day: insights.find(i => i.includes('productive day')) || "Not enough data for productive day.",
                                active_project: insights.find(i => i.includes('active project')) || "No project data yet.",
                                total_time: `Your total recorded time is <strong>${Utils.formatTime(state.history.reduce((a,b) => a + b.duration, 0), false).full}</strong>.`
                            };
                            this.renderAIMessage(insightMap[result.insight] || "I couldn't find that specific insight.");
                            break;
                        }
                        case 'suggest': {
                            let suggestion;
                            if (result.type === 'task') {
                                suggestion = "How about a focused 25-minute Pomodoro session on your most active project?";
                            } else if (result.type === 'break') {
                                suggestion = "A 5-minute break can boost your focus. Try a short walk or some stretches.";
                            } else { // goal
                                const { commonProjects } = state.userStats;
                                const mostCommonProjectId = Object.keys(commonProjects).sort((a,b) => commonProjects[b] - commonProjects[a])[0];
                                if (mostCommonProjectId) {
                                    const projectName = state.projects.find(p => p.id === mostCommonProjectId)?.name;
                                    suggestion = `You often work on '${projectName}'. How about setting a daily goal of 1 hour for it?`;
                                } else {
                                    suggestion = "To suggest a goal, I need to learn more about your projects. Keep tracking your sessions!";
                                }
                            }
                            this.renderAIMessage(suggestion);
                            break;
                        }
                        case 'filter_history':
                            this.dom.historySearch.value = result.filter;
                            this.renderHistory();
                            this.switchView('history-view');
                            this.renderAIMessage(`I've filtered your history for "${result.filter}".`);
                            break;
                        case 'delete_last_session':
                             if (state.history.length > 0) {
                                Store.deleteHistory(state.history[0].id);
                                this.renderAIMessage("Done. I've deleted your last session.");
                                this.renderHistory();
                            } else {
                                this.renderAIMessage("No sessions to delete.");
                            }
                            break;
                        case 'export_data':
                            this.handleExportData();
                            break;
                        case 'import_data':
                            this.renderAIMessage("Please click the button to select your JSON data file.", (el) => {
                                const btn = document.createElement('button');
                                btn.textContent = 'Import Data';
                                btn.onclick = () => this.dom.importFileInput.click();
                                const actionsContainer = el.querySelector('.data-actions');
                                if (actionsContainer) {
                                    actionsContainer.appendChild(btn);
                                }
                            });
                            break;
                        default:
                            this.renderAIMessage("I'm sorry, I don't quite understand. You can ask me things like 'show summary', 'export my data', or 'my name is...'.");
                            break;
                    }
                    this.renderAISuggestions();
                }, 500);
            }

            renderUserMessage(text) {
                const messageEl = document.createElement('div');
                messageEl.className = 'user-message';
                messageEl.textContent = text;
                this.dom.aiChatLog.appendChild(messageEl);
                this.dom.aiChatLog.scrollTop = this.dom.aiChatLog.scrollHeight;
            }

            renderAIMessage(html, callback) {
                const messageEl = document.createElement('div');
                messageEl.className = 'ai-message';
                messageEl.innerHTML = html;
                
                // ALWAYS add a container for potential action buttons. This is the fix.
                const actionsContainer = document.createElement('div');
                actionsContainer.className = 'data-actions';
                messageEl.appendChild(actionsContainer);

                this.dom.aiChatLog.appendChild(messageEl);
                this.dom.aiChatLog.scrollTop = this.dom.aiChatLog.scrollHeight;
                if(callback) callback(messageEl);
            }
            
            renderChartInMessage(messageEl, chartData) {
                const canvas = messageEl.querySelector('canvas');
                if(!canvas || !chartData) return;
                
                const isDark = Store.getState().theme === 'dark';
                const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                const labelColor = isDark ? '#f0f0f5' : '#1a1c2c';

                new Chart(canvas, {
                    type: chartData.type,
                    data: chartData,
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: labelColor, font: { family: "'Teko', sans-serif" } } },
                            x: { grid: { display: false }, ticks: { color: labelColor, font: { family: "'Teko', sans-serif" } } }
                        }
                    }
                });
            }
            
            // --- Timer Logic ---
            setupAnimatedDisplay() {
                ['hoursGroup', 'minutesGroup', 'secondsGroup'].forEach(groupId => {
                    const group = this.dom[groupId];
                    group.innerHTML = `
                        <div class="digit-container"><div class="digit-roller">${Array.from({length: 10}, (_, i) => `<div class="digit">${i}</div>`).join('')}</div></div>
                        <div class="digit-container"><div class="digit-roller">${Array.from({length: 10}, (_, i) => `<div class="digit">${i}</div>`).join('')}</div></div>
                    `;
                });
                this.updateTimeDisplay(0);
            }
            
            handleTimerFinished() {
                SoundEngine.playNotification();
                navigator.vibrate?.(200);
                NotificationManager.show("Timer Finished!", "Your timer has completed. Don't forget to save your session.");
            }

            switchMode(mode, reset = true) {
                if (this.timerEngine.isRunning) return;
                if (this.timerEngine.mode === mode && reset) {
                    this.timerEngine.reset();
                    return;
                }

                if (reset) this.timerEngine.reset();
                this.timerEngine.mode = mode;

                this.dom.stopwatchModeBtn.classList.toggle('active', mode === 'stopwatch');
                this.dom.timerModeBtn.classList.toggle('active', mode === 'timer');

                this.dom.timerInputWrapper.style.display = mode === 'timer' ? 'flex' : 'none';
                this.dom.lapResetBtn.textContent = mode === 'stopwatch' ? 'Lap' : 'Reset';
                
                this.updateLapsDisplay();
            }

            handleStartStop() {
                if (this.timerEngine.isRunning) {
                    this.timerEngine.stop();
                    this.dom.startStopBtn.textContent = 'Start';
                    this.dom.startStopBtn.classList.remove('running');
                    this.dom.lapResetBtn.textContent = 'Reset';

                    if (this.timerEngine.pendingSession) {
                        this.openSessionModal('new');
                    }

                } else {
                    if (this.timerEngine.mode === 'timer' && this.timerEngine.elapsedTime <= 0) {
                        const h = parseInt(this.dom.hoursInput.value || 0) * 3600;
                        const m = parseInt(this.dom.minutesInput.value || 0) * 60;
                        const s = parseInt(this.dom.secondsInput.value || 0);
                        const durationMs = (h + m + s) * 1000;
                        
                        if (durationMs <= 0) {
                            this.showToast("Please set a timer duration.");
                            return;
                        }
                        this.timerEngine.setTimer(durationMs);
                    }
                    
                    this.timerEngine.start();
                    this.dom.startStopBtn.textContent = 'Stop';
                    this.dom.startStopBtn.classList.add('running');
                    this.dom.lapResetBtn.textContent = this.timerEngine.mode === 'stopwatch' ? 'Lap' : 'Reset';
                }
            }

            handleLapReset() {
                if (this.timerEngine.isRunning) {
                    if (this.timerEngine.mode === 'stopwatch') this.timerEngine.lap();
                    else this.timerEngine.reset();
                } else {
                    this.timerEngine.reset();
                }
                this.updateLapsDisplay();
            }
            
            updateTimeDisplay(ms) {
                const { ms: msPart, parts } = Utils.formatTime(ms, true, true);
                this.dom.msDisplay.textContent = msPart;

                // Animate digits only if they change
                if(this.lastTimeParts.seconds !== parts.seconds) this.updateDigitGroup('secondsGroup', parts.seconds);
                if(this.lastTimeParts.minutes !== parts.minutes) this.updateDigitGroup('minutesGroup', parts.minutes);
                if(this.lastTimeParts.hours !== parts.hours) this.updateDigitGroup('hoursGroup', parts.hours);
                
                this.lastTimeParts = parts;
            }

            updateDigitGroup(groupId, value) {
                const group = this.dom[groupId];
                const rollers = group.querySelectorAll('.digit-roller');
                const [digit1, digit2] = value;
                rollers[0].style.transform = `translateY(-${digit1 * 10}%)`;
                rollers[1].style.transform = `translateY(-${digit2 * 10}%)`;
            }

            updateLapsDisplay() {
                this.dom.lapsContainer.innerHTML = this.timerEngine.laps.map((lap, index) => {
                    const { full, ms } = Utils.formatTime(lap.time, true, false);
                    return `<div class="lap-item">
                                <span>Lap ${this.timerEngine.laps.length - index}</span>
                                <span>${full}.${ms}</span>
                            </div>`;
                }).join('');
            }

            // --- History Logic ---
            renderHistory() {
                const query = this.dom.historySearch.value.toLowerCase();
                const history = Store.getHistory();
                const projects = Store.getProjects();
                
                const filteredHistory = history.filter(s => {
                    const project = projects.find(p => p.id === s.projectId);
                    return s.label.toLowerCase().includes(query) || 
                           s.type.toLowerCase().includes(query) || 
                           (project && project.name.toLowerCase().includes(query));
                });

                this.dom.historyList.innerHTML = filteredHistory.length === 0
                    ? `<li style="text-align: center; opacity: 0.7;">No sessions found.</li>`
                    : filteredHistory.map(s => this.createHistoryItemHTML(s, projects)).join('');
                
                this.bindHistoryItemEvents();
            }

            createHistoryItemHTML(session, projects) {
                const { full } = Utils.formatTime(session.duration, false);
                const date = new Date(session.timestamp).toLocaleDateString();
                const startTime = Utils.formatDateTime(session.startTime);
                const finishTime = Utils.formatDateTime(session.finishTime);
                const project = projects.find(p => p.id === session.projectId);
                const pinnedClass = session.isPinned ? 'is-pinned' : '';

                return `
                <li class="history-item-wrapper ${pinnedClass}" data-id="${session.id}">
                    <div class="swipe-actions">
                        <button class="swipe-btn pin-btn"><i class="fa-solid fa-thumbtack"></i><span>${session.isPinned ? 'Unpin' : 'Pin'}</span></button>
                        <button class="swipe-btn edit-btn"><i class="fa-solid fa-pencil"></i><span>Edit</span></button>
                        <button class="swipe-btn delete-btn"><i class="fa-solid fa-trash"></i><span>Delete</span></button>
                    </div>
                    <div class="history-item">
                        <div class="history-item-content">
                            <div class="history-item-header">
                                <span class="history-item-label">${session.label}</span>
                                <div class="history-item-duration">
                                    ${full}
                                    <div class="history-item-times">${startTime} - ${finishTime}</div>
                                </div>
                            </div>
                            <div class="history-item-footer">
                                ${project ? `<span class="project-tag">${project.name}</span>` : '<span></span>'}
                                <span>${date}</span>
                            </div>
                        </div>
                    </div>
                </li>`;
            }
            
            bindHistoryItemEvents() {
                 this.dom.historyList.querySelectorAll('.history-item-wrapper').forEach(wrapper => {
                    const item = wrapper.querySelector('.history-item');
                    const id = wrapper.dataset.id;
                    let startX = 0;
                    let currentX = 0;
                    let isSwiping = false;
                    const maxSwipe = 240; // 3 buttons * 80px

                    const handleSwipe = (e) => {
                        if (!isSwiping) return;
                        currentX = e.touches[0].clientX - startX;
                        if (currentX < 0 && currentX > -maxSwipe) {
                           item.style.transform = `translateX(${currentX}px)`;
                        }
                    };

                    item.addEventListener('touchstart', (e) => {
                        startX = e.touches[0].clientX;
                        isSwiping = true;
                        item.style.transition = 'none';
                    });

                    item.addEventListener('touchmove', handleSwipe);

                    item.addEventListener('touchend', () => {
                        isSwiping = false;
                        item.style.transition = 'transform var(--transition-speed) ease';
                        if (currentX < -60) {
                            item.style.transform = `translateX(-${maxSwipe}px)`;
                        } else {
                            item.style.transform = 'translateX(0)';
                        }
                        currentX = 0;
                    });
                    
                    wrapper.querySelector('.pin-btn').addEventListener('click', () => {
                         Store.togglePin(id);
                         this.renderHistory();
                    });
                    wrapper.querySelector('.edit-btn').addEventListener('click', () => this.openSessionModal('edit', id));
                    wrapper.querySelector('.delete-btn').addEventListener('click', () => {
                        ConfirmationModal.show("Do you want to permanently delete this session?")
                            .then(() => {
                                wrapper.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
                                wrapper.style.transform = 'scale(0.8)';
                                wrapper.style.opacity = '0';
                                setTimeout(() => {
                                   Store.deleteHistory(id);
                                   this.showToast("Session deleted.");
                                   this.renderHistory();
                                }, 300)
                            })
                            .catch(() => {
                                // User cancelled, do nothing, maybe slide back
                                item.style.transform = 'translateX(0)';
                            });
                    });

                });
            }
            
            // --- Modal Logic ---
            openSessionModal(type, id = null) {
                this.editingSession = { type, id };
                const projects = Store.getProjects();
                
                this.dom.projectSelect.innerHTML = '<option value="">None</option>' + projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                this.dom.newProjectInput.value = '';

                if (type === 'edit') {
                    const session = Store.getHistory().find(s => s.id === id);
                    if (!session) return;
                    this.dom.modalTitle.innerHTML = '<i class="fa-solid fa-pen-to-square"></i> Edit Session';
                    this.dom.sessionLabelInput.value = session.label;
                    this.dom.projectSelect.value = session.projectId || '';
                    this.dom.deleteSessionBtn.style.display = 'block';
                } else { // 'new'
                    const sessionData = this.timerEngine.pendingSession;
                    this.dom.modalTitle.innerHTML = '<i class="fa-solid fa-save"></i> Save Session';
                    const suggestedLabel = `${sessionData.type.charAt(0).toUpperCase() + sessionData.type.slice(1)} Session`;
                    this.dom.sessionLabelInput.value = suggestedLabel;
                    this.dom.projectSelect.value = sessionData.projectId || '';
                    this.dom.deleteSessionBtn.style.display = 'none';
                }
                
                this.dom.sessionModal.classList.add('visible');
                this.dom.sessionLabelInput.focus();
            }

            closeSessionModal() {
                this.editingSession = null;
                this.dom.sessionModal.classList.remove('visible');
                if (this.timerEngine.pendingSession && !this.timerEngine.isRunning) {
                     this.timerEngine.reset();
                }
            }

            handleSaveSession() {
                const label = this.dom.sessionLabelInput.value.trim();
                if (!label) {
                    this.showToast("Please provide a session label.");
                    return;
                }

                let projectId = this.dom.projectSelect.value;
                const newProjectName = this.dom.newProjectInput.value.trim();

                if (newProjectName) {
                    const existingProject = Store.getProjects().find(p => p.name.toLowerCase() === newProjectName.toLowerCase());
                    projectId = existingProject ? existingProject.id : Store.addProject(newProjectName).id;
                }

                if (this.editingSession.type === 'new') {
                    const session = { id: Utils.generateUUID(), label, projectId, timestamp: new Date().toISOString(), ...this.timerEngine.pendingSession };
                    Store.addHistory(session);
                    AI.updateLearnings(Store.getState(), session); // AI learns from new session
                    Store.save(); // Save the updated learnings
                    this.showToast(AI.getMotivationalFeedback());
                } else { // 'edit'
                    Store.updateHistory(this.editingSession.id, label, projectId);
                    this.showToast('Session updated successfully!');
                }
                
                this.renderHistory();
                this.closeSessionModal();
            }

            async handleDeleteSession() {
                if (this.editingSession && this.editingSession.type === 'edit') {
                    try {
                        await ConfirmationModal.show("Do you want to permanently delete this session?");
                        // User confirmed
                        Store.deleteHistory(this.editingSession.id);
                        this.showToast("Session deleted.");
                        this.renderHistory();
                        this.closeSessionModal();
                    } catch {
                        // User cancelled, do nothing.
                    }
                }
            }

            // --- Data Management ---
            handleExportData() {
                const data = JSON.stringify(Store.getState(), null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ChronoMind_Backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                this.renderAIMessage("Your data has been successfully exported.");
            }

            async handleImportData(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedState = JSON.parse(e.target.result);
                        
                        await ConfirmationModal.show("This will overwrite all current data. Are you sure you want to proceed?");
                        
                        Store.replaceState(importedState);
                        this.showToast("Data imported successfully!");
                        // Force a full re-render of the app
                        this.applyTheme();
                        this.renderHistory();
                        this.initAIView(); // This will clear the chat and show the new welcome message

                    } catch (error) {
                        this.showToast(`Import failed: ${error.message}`);
                    } finally {
                        // Reset the file input to allow re-importing the same file
                        this.dom.importFileInput.value = '';
                    }
                };
                reader.readAsText(file);
            }
            
            // --- Toast Notifications ---
            showToast(message) {
                this.dom.toast.textContent = message;
                this.dom.toast.classList.add('show');
                setTimeout(() => {
                    this.dom.toast.classList.remove('show');
                }, 3000);
            }
        }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            new App();
        });
    </script>
</body>
</html>